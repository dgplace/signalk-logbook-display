# Project Architecture and File Guide

## Application Overview
- Signal K plugin that exposes a web interface for exploring logbook voyages and generating polar data.
- Node.js back-end components parse raw YAML log entries into structured JSON consumed by the front-end.
- Front-end single-page app (SPA) renders voyage tracks on Leaflet maps and provides rich voyage analytics.
- Utility scripts support data preparation, polar analysis, and batch log maintenance outside the runtime path.

## Data Flow Summary
1. YAML logbook entries are stored under `~/.signalk/plugin-config-data/signalk-logbook/`.
2. `parse_logbook.js` processes the YAML files into `public/voyages.json`, enriching points with activity metadata.
3. `parse_polar.js` transforms the voyage output into polar performance points saved in `public/Polar.json`.
4. The `plugin.js` router or standalone `server.js` endpoint triggers regeneration on demand.
5. `public/app.js` fetches the JSON resources, renders voyages on the map, and exposes UI interactions.

## Core Files
- `plugin.js`: Signal K plugin entry point. Registers HTTP endpoints, spawns the logbook parser, writes voyage and polar JSON, and integrates with the host router.
- `server.js`: Lightweight development server for the `public/` directory. Mirrors the plugin endpoints to regenerate voyage and polar data locally.
- `parse_logbook.js`: Node.js CLI tool that ingests daily YAML logs, classifies activity, computes voyage statistics, and emits structured voyage data.
- `parse_polar.js`: Helper module that derives polar performance points from voyage data, normalising headings and wind metrics.
- `public/app.js`: Front-end SPA built on Leaflet. Manages voyage selection, table rendering, map overlays, wind visualisation, and user interactions.
- `public/index.html`: Base HTML shell loading the SPA, styles, and UI scaffolding.
- `public/styles.css`: Styling for the logbook UI, including map layout, table presentation, and responsive behaviour.
- `public/voyages.json`: Generated voyage dataset consumed by the SPA (overwritten via parser runs).
- `public/Polar.json`: Generated polar dataset used by the polar plotting tooling.

## Supporting Scripts
- `scripts/generate_polar.py`: Matplotlib-based utility that plots polar diagrams from `public/Polar.json`, supporting saving or interactive display.
- `scripts/merge_course_changes.py`: Cleans and merges course change log entries, with optional maxima position fixes.
- `scripts/merge_course_changes_dir.py`: Batch wrapper around `merge_course_changes.py` for directory-wide processing.
- `scripts/fetch-voyages.sh`: Convenience shell script for retrieving voyage data (if configured by the user).
- `scripts/deploy-to-signalk.sh`: Deploys `public/` assets (excluding `voyages.json`) and root-level helper scripts into a local Signal K install.
- `scripts/build-plugin.sh`: Bundles plugin assets for distribution.

## Additional Assets
- `polar.txt`: Sample polar data reference file used during analysis.
- `polar_diagram.png`: Example polar diagram output generated by the plotting script.
- `README.md`: High-level project instructions and setup guidance.
- `AGENTS.md`: Automation and agent guidelines for repository maintenance.
- `LOG.md`: (This document) Describes architecture, data flow, and file responsibilities for quick onboarding.

## Operational Notes
- Plugin endpoints: `GET /plugins/voyage-webapp/generate` regenerates voyages and polar data; `/generate/polar` recomputes polar data only.
- Development server runs at `http://localhost:3645/` via `node server.js` and mirrors plugin regeneration endpoints.
- Front-end relies on Leaflet globals; ensure assets are served from `public/` for proper styling and script load.
- Parser scripts expect valid ISO datetimes in YAML and handle anchored/motoring classification via text cues and speed heuristics.

## Change Log
- Updated deployment helper (now `scripts/deploy-to-signalk.sh`) to copy root-level `.js` files into the Signal K module directory alongside the public asset sync.
- Adopted the CARTO Voyager basemap and rethemed the front-end with a light palette for balanced contrast across the app.
- Added a header toggle for the wind overlay.
- Resized point markers to roughly 1.1Ã— the route weight and size wind circles to fixed pixel sizing for consistent visibility.
- Enforced a 700px minimum page width to preserve layout integrity on narrow viewports.
- Set a 150px minimum height on the voyage table wrapper to maintain legibility when space is constrained.
- Let the main layout exceed the viewport when necessary so the page scrolls instead of shrinking the map, keeping the map row at least 400px tall and ensuring the table row never compresses below 230px even when the window is short.
