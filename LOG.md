# Project Architecture and File Guide

## Application Overview
- Signal K plugin that exposes a web interface for exploring logbook voyages and generating polar data.
- Node.js back-end components parse raw YAML log entries into structured JSON consumed by the front-end.
- Front-end single-page app (SPA) renders voyage tracks on Leaflet maps and provides rich voyage analytics.
- Utility scripts support data preparation, polar analysis, and batch log maintenance outside the runtime path.

## Data Flow Summary
1. YAML logbook entries are stored under `~/.signalk/plugin-config-data/signalk-logbook/`.
2. `parse_logbook.js` processes the YAML files into `public/voyages.json`, enriching points with activity metadata and ignoring speed/wind readings that lack positional data.
3. `parse_polar.js` transforms the voyage output into polar performance points saved in `public/Polar.json`.
4. The `plugin.js` router or standalone `server.js` endpoint triggers regeneration on demand.
5. `public/app.js` fetches the JSON resources, renders voyages on the map, and exposes UI interactions.

## Core Files
- `plugin.js`: Signal K plugin entry point. Registers HTTP endpoints, spawns the logbook parser, writes voyage and polar JSON, and integrates with the host router.
- `server.js`: Lightweight development server for the `public/` directory. Mirrors the plugin endpoints to regenerate voyage and polar data locally.
- `parse_logbook.js`: Node.js CLI tool that ingests daily YAML logs, classifies activity, computes voyage statistics, and emits structured voyage data.
- `parse_polar.js`: Helper module that derives polar performance points from voyage data, normalising headings and wind metrics.
- `public/app.js`: Front-end orchestrator that wires data fetching, module initialisation, and high-level user interactions.
- `public/map.js`: Leaflet controller that builds voyage overlays, handles map/background interactions, and coordinates selection state with other modules.
- `public/view.js`: Responsive layout utility that manages mobile/desktop toggles, tab behaviour, and layout-driven map resizing.
- `public/table.js`: Table controller responsible for rendering voyage/day rows, maintaining row state, and raising callbacks for row events.
- `public/data.js`: Data helpers focused on voyage datasets, totals aggregation, and low-level voyage point utilities.
- `public/util.js`: Shared presentation helpers including heading/DMS formatting and datetime labelling.
- `public/index.html`: Base HTML shell loading the SPA, styles, and UI scaffolding.
- `public/styles.css`: Styling for the logbook UI, including map layout, table presentation, and responsive behaviour.
- `public/voyages.json`: Generated voyage dataset consumed by the SPA (overwritten via parser runs).
- `public/Polar.json`: Generated polar dataset used by the polar plotting tooling.

## Supporting Scripts
- `scripts/generate_polar.py`: Matplotlib-based utility that plots polar diagrams from `public/Polar.json`, supporting saving or interactive display.
- `scripts/merge_course_changes.py`: Cleans and merges course change log entries, with optional maxima position fixes.
- `scripts/merge_course_changes_dir.py`: Batch wrapper around `merge_course_changes.py` for directory-wide processing.
- `scripts/fetch-voyages.sh`: Convenience shell script for retrieving voyage data (if configured by the user).
- `scripts/deploy-to-signalk.sh`: Deploys `public/` assets (excluding `voyages.json`) and root-level helper scripts into a local Signal K install.
- `scripts/build-plugin.sh`: Bundles plugin assets for distribution.

## Additional Assets
- `polar.txt`: Sample polar data reference file used during analysis.
- `polar_diagram.png`: Example polar diagram output generated by the plotting script.
- `README.md`: High-level project instructions and setup guidance.
- `AGENTS.md`: Automation and agent guidelines for repository maintenance.
- `LOG.md`: (This document) Describes architecture, data flow, and file responsibilities for quick onboarding.

## Operational Notes
- Plugin endpoints: `GET /plugins/voyage-webapp/generate` regenerates voyages and polar data; `/generate/polar` recomputes polar data only.
- Development server runs at `http://localhost:3645/` via `node server.js` and mirrors plugin regeneration endpoints.
- Front-end relies on Leaflet globals; ensure assets are served from `public/` for proper styling and script load.
- Parser scripts expect valid ISO datetimes in YAML and handle anchored/motoring classification via text cues and speed heuristics.
- Parser max-speed and max-wind statistics ignore entries that do not include a valid GPS position to prevent sensor spikes from inflating voyage summaries.
- Voyage grouping uses UTC calendar days so legs that cross local timezone offsets remain in the same voyage when dates are consecutive.

## Change Log
- Updated deployment helper (now `scripts/deploy-to-signalk.sh`) to copy root-level `.js` files into the Signal K module directory alongside the public asset sync.
- Adopted the CARTO Voyager basemap and rethemed the front-end with a light palette for balanced contrast across the app.
- Added a header toggle for the wind overlay.
- Resized point markers to roughly 1.1Ã— the route weight and size wind circles to fixed pixel sizing for consistent visibility.
- Enforced a 700px minimum page width to preserve layout integrity on narrow viewports.
- Set a 150px minimum height on the voyage table wrapper to maintain legibility when space is constrained.
- Let the main layout exceed the viewport when necessary so the page scrolls instead of shrinking the map, keeping the map row at least 400px tall and ensuring the table row never compresses below 230px even when the window is short.
- Replaced the previous 700px minimum width requirement with a mobile breakpoint that swaps the grid for accessible tabs, letting phone users toggle between the voyage table and the map.
- Default the mobile layout to the Map tab on load and automatically switch back to the map whenever a voyage or day segment is selected from the table.
- Ensure the mobile layout is applied before selections so reloading with an active voyage keeps the highlighted track visible and refits the map immediately.
- Hide the table maximize control when the responsive mobile layout is active and reduce the voyage table font size slightly for consistency across viewports.
- Scroll the page to the top whenever the mobile layout switches back to the Map tab after a voyage or day selection so the map remains in view.
- In the mobile layout hide the voyage table's Avg Speed and Avg Wind columns to keep the table readable on small screens.
- Suppress the `kn` units for Max Speed and Max Wind cells when the mobile layout is active to reduce visual clutter on phones.
- Hide the End column and the totals summary row from the mobile voyage table to keep the layout focused on primary metrics.
- Add strong conditional caching to `server.js`, emitting ETags and `Last-Modified` headers (including Safari-specific `; length=` suffix parsing and unquoted validator matches on conditional headers) so reloading the web app avoids retransferring unchanged `voyages.json`.
- Update the SPA fetch logic to request `voyages.json` with `cache: 'no-cache'`, ensuring browsers send conditional requests even on manual reloads.
- Split the SPA into modular files (`public/app.js`, `public/map.js`, `public/view.js`, `public/table.js`, `public/util.js`, `public/data.js`) so map controls, layout behaviour, table state, shared utilities, and data utilities are isolated for clearer maintenance and reuse.
- Centralised formatting and heading helpers inside `public/util.js`, keeping map and table modules focused on orchestration.
- Dedicated `public/table.js` now owns voyage table state, DOM rendering, row selection, and accessor helpers to keep table concerns separate from map rendering.
- Moved the map background selection logic into `public/map.js` so the map controller owns its event handlers.
- Normalised voyage, segment, max-speed, and reset workflows through a shared pub/sub bus (`public/events.js`), letting map, table, and history listeners coordinate via event emission instead of bespoke callbacks.
- Extracted overlay and icon builders into `public/overlays.js`, leaving `public/map.js` focused on Leaflet lifecycle, history updates, and event wiring while reusing the overlay helpers across voyage and segment selections.
- Documented cross-module voyage structures in `public/types.js` and added module-level API summaries to aid future maintenance.
- Added prefers-color-scheme driven theming with CSS custom properties, automatically swapping the UI palette while keeping the Leaflet base tiles on CARTO Voyager in both modes so dark theme users still get a readable map.
- Lowered dark-mode Voyager tile brightness further and increased contrast more so the basemap stays legible without overpowering the darker UI.
- Guard voyage max-speed and max-wind calculations by excluding log entries without coordinates so instrument glitches (e.g., 46 kt SOG with no position) cannot distort voyage summaries.
- Group voyages by UTC day boundaries to avoid splitting a single journey across multiple voyages when entries occur near local midnight in different timezones.
- Revert voyage grouping to a strict 24-hour gap so voyages separated by more than a day (e.g., July 1 vs. July 4) are treated as distinct trips.
