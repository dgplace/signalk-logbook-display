<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Logbook</title>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  /* adopt Signal K theme variables with fallbacks */
  body, html {
    height: 100%;
    margin: 0;
    background-color: var(--background-page-color, #ffffff);
    color: var(--text-color, #000000);
    font-family: var(--font-family, sans-serif);
  }
  .container {
    width: 95%;
    margin: 0 auto;
  }
  .header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #map {
    width: 100%;
    height: 60vh;  /* responsive height: 60% of viewport */
    min-height: 300px;
    margin-top: 1em;
  }
  /* style the regeneration button to match SK buttons */
  button#regenBtn {
    background-color: var(--button-primary-bg-color, #2563eb);
    color: var(--button-primary-text-color, #ffffff);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
  }
  button#regenBtn:hover {
    background-color: var(--button-primary-bg-hover-color, #1e40af);
  }
  /* give the table Signal K‑style borders and zebra stripes */
  table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--border-color, #334155);
    border-radius: 4px;
    overflow: hidden;
  }
  th, td {
    padding: 8px;
    border: 1px solid var(--border-color, #334155);
  }
  th {
    background-color: var(--table-header-bg-color, #e2e8f0);
    color: var(--table-header-text-color, #000000);
  }
  tbody tr:nth-child(odd) {
    background-color: var(--table-row-bg-alt-color, rgba(0,0,0,0.03));
  }
  tbody tr:hover {
    background-color: var(--table-row-hover-bg-color, blue);
    color: white;
  }
  .details-panel {
    margin-top: 0.75em;
    padding: 10px;
    border: 1px solid var(--border-color, #334155);
    border-radius: 4px;
    background-color: var(--background-input-color, #f8fafc);
  }
</style>
</head>
<body>
<div class="container">
  <div class="header-bar">
    <h2>Logbook</h2>
    <button id="regenBtn">Regenerate voyages</button>
  </div>
  <table id="voyTable">
    <thead><tr><th>#</th><th>Start</th><th>End</th><th>NM</th><th>Max Speed</th><th>Avg Speed</th><th>Max Wind</th><th>Avg Wind</th><th>Avg Wind Dir</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="map"></div>
  <div id="pointDetails" class="details-panel" aria-live="polite"></div>
</div>

<script>
function degToCompass(deg) {
  const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
  return dirs[Math.round(deg / 45) % 8];
}
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map, polylines = [], maxMarker;
let activeLine = null;           // currently highlighted red line
let activeLineClick = null;      // stored click handler for active line
let selectedPointMarker = null;  // marker for selected point

async function load() {
  // fetch the data
  const res  = await fetch('voyages.json');
  const data = await res.json();

  // if map already exists (after regeneration), remove it
  if (map) {
    map.off();       // remove all listeners
    map.remove();    // safely destroy the Leaflet map instance
  }
  polylines = [];
  maxMarker = null;

  map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              { maxZoom: 19 }).addTo(map);

  const tbody = document.querySelector('#voyTable tbody');
  tbody.innerHTML = ''; // clear existing rows

  data.voyages.forEach((v, i) => {
    // create table row
    const avgWindDir = (v.avgWindHeading !== undefined && v.avgWindHeading !== null) ? degToCompass(v.avgWindHeading) : '';
    const row = tbody.insertRow();
    row.innerHTML =
      `<td>${i+1}</td><td>${new Date(v.startTime).toLocaleString()}</td>
       <td>${new Date(v.endTime).toLocaleString()}</td>
       <td>${v.nm.toFixed(1)}</td>
       <td>${v.maxSpeed.toFixed(1)}</td>
       <td>${v.avgSpeed.toFixed(1)}</td>
       <td>${v.maxWind.toFixed(1)}</td>
       <td>${v.avgWindSpeed.toFixed(1)}</td>
       <td>${avgWindDir}</td>`;

    // draw the polyline and store it
    const latLngs = v.coords.map(([lon, lat]) => [lat, lon]);
    const line = L.polyline(latLngs, { color: 'blue', weight: 2 }).addTo(map);
    polylines.push(line);
    if (i === 0) map.fitBounds(line.getBounds());

    // click handler to highlight this line
    row.addEventListener('click', () => {
      // reset all polylines to default style
      polylines.forEach(pl => pl.setStyle({ color: 'blue', weight: 2 }));
      // highlight selected voyage
      line.setStyle({ color: 'red', weight: 4 });
      activeLine = line;
      // fit map bounds to selected line
      map.fitBounds(line.getBounds());
      // remove existing marker
      if (maxMarker) {
        map.removeLayer(maxMarker);
        maxMarker = null;
      }
      if (v.maxSpeedCoord && v.maxSpeedCoord.length === 2) {
        const [lon, lat] = v.maxSpeedCoord;
        maxMarker = L.circleMarker([lat, lon], { color: 'orange', radius: 6 }).addTo(map);
        maxMarker.bindPopup(`Max SoG: ${v.maxSpeed.toFixed(1)} kn`).openPopup();
      }

      // clear previous point selection and handler
      if (selectedPointMarker) {
        map.removeLayer(selectedPointMarker);
        selectedPointMarker = null;
      }
      if (activeLineClick) {
        line.off('click', activeLineClick);
        activeLineClick = null;
      }

      // attach click handler to red path to select nearest point
      const points = Array.isArray(v.points) && v.points.length ? v.points :
                     (Array.isArray(v.entries) && v.entries.length ? v.entries :
                       v.coords.map(([lon, lat]) => ({ lon, lat })));

      const onLineClick = (e) => {
        if (!points || points.length === 0) return;
        // find nearest point to clicked latlng
        const clickLL = e.latlng;
        let bestIdx = 0;
        let bestDist = Infinity;
        for (let idx = 0; idx < points.length; idx++) {
          const p = points[idx];
          if (typeof p.lat !== 'number' || typeof p.lon !== 'number') continue;
          const pll = L.latLng(p.lat, p.lon);
          const d = clickLL.distanceTo(pll);
          if (d < bestDist) {
            bestDist = d;
            bestIdx = idx;
          }
        }
        const sel = points[bestIdx];
        const lat = sel.lat, lon = sel.lon;
        // move or create selection marker
        if (!selectedPointMarker) {
          selectedPointMarker = L.circleMarker([lat, lon], { color: 'red', radius: 6, weight: 2, fillOpacity: 0.7 }).addTo(map);
        } else {
          selectedPointMarker.setLatLng([lat, lon]);
        }
        // update details panel
        renderPointDetails(sel);
      };
      line.on('click', onLineClick);
      activeLineClick = onLineClick;
      // initial details hint
      setDetailsHint('Click on the red path to inspect a point.');
    });
  });
}

// call load() initially
load().then(() => setDetailsHint('Select a voyage, then click the red path to inspect points.')).catch(console.error);

// regenerate button logic, if you still have it
document.getElementById('regenBtn').addEventListener('click', async () => {
  await fetch('/plugins/voyage-webapp/generate', {
    method: 'GET',
    credentials: 'include'
  });
  await load();
});
</script>

<script>
// Simple details panel rendering
function setDetailsHint(msg) {
  const panel = document.getElementById('pointDetails');
  panel.innerHTML = `<em>${msg}</em>`;
}

function degToCompassLocal(deg) {
  const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
  return dirs[Math.round(deg / 45) % 8];
}

function renderPointDetails(point) {
  const panel = document.getElementById('pointDetails');
  const entry = point.entry || point; // fall back if only lon/lat exist

  // build a compact summary + raw JSON
  const when = entry.datetime ? new Date(entry.datetime).toLocaleString() : '—';
  const sog = entry?.speed?.sog;
  const stw = entry?.speed?.stw;
  const windSpd = entry?.wind?.speed;
  const windDir = entry?.wind?.direction;
  const windDirTxt = typeof windDir === 'number' ? `${windDir.toFixed(0)}° (${degToCompassLocal(windDir)})` : '—';

  const summary = `
    <div><strong>Time:</strong> ${when}</div>
    <div><strong>Position:</strong> ${point.lat?.toFixed?.(5) ?? '—'}, ${point.lon?.toFixed?.(5) ?? '—'}</div>
    <div><strong>SOG:</strong> ${typeof sog === 'number' ? sog.toFixed(2) + ' kn' : '—'}</div>
    <div><strong>STW:</strong> ${typeof stw === 'number' ? stw.toFixed(2) + ' kn' : '—'}</div>
    <div><strong>Wind:</strong> ${typeof windSpd === 'number' ? windSpd.toFixed(2) + ' kn' : '—'} @ ${windDirTxt}</div>
  `;

  const raw = `<pre style="white-space: pre-wrap;">${escapeHtml(JSON.stringify(entry, null, 2))}</pre>`;
  panel.innerHTML = `<h3 style="margin:0 0 6px 0;">Point Details</h3>${summary}<details><summary>Raw data</summary>${raw}</details>`;
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}
</script>

</body>
</html>
