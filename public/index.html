<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Logbook</title>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  /* adopt Signal K theme variables with fallbacks */
  body, html {
    height: 100%;
    margin: 0;
    background-color: var(--background-page-color, #0f172a);
    color: var(--text-color, #e5e7eb);
    font-family: var(--font-family, sans-serif);
  }
  #map {
    height: 60%;
  }
  /* style the regeneration button to match SK buttons */
  button#regenBtn {
    background-color: var(--button-primary-bg-color, #2563eb);
    color: var(--button-primary-text-color, #ffffff);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
  }
  button#regenBtn:hover {
    background-color: var(--button-primary-bg-hover-color, #1e40af);
  }
  /* give the table Signal K‑style borders and zebra stripes */
  table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--border-color, #334155);
    border-radius: 4px;
    overflow: hidden;
  }
  th, td {
    padding: 8px;
    border: 1px solid var(--border-color, #334155);
  }
  th {
    background-color: var(--table-header-bg-color, #1e293b);
    color: var(--table-header-text-color, #e2e8f0);
  }
  tbody tr:nth-child(odd) {
    background-color: var(--table-row-bg-alt-color, rgba(255,255,255,0.03));
  }
  tbody tr:hover {
    background-color: var(--table-row-hover-bg-color, rgba(255,255,255,0.05));
  }
</style>
</head>
<body>
<h2>Logbook</h2>
<!-- inside <body> -->
<button id="regenBtn">Regenerate voyages</button>
<!-- existing table and map elements go here -->

<script>
function degToCompass(deg) {
  const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
  return dirs[Math.round(deg / 45) % 8];
}
async function regenerateAndReload() {
  // call the server route to regenerate JSON
  await fetch('/plugins/voyage-webapp/generate', { method: 'GET', credentials: 'include' });
  // reload the map data
  await init(); // call your init() function from earlier
}

document.getElementById('regenBtn').addEventListener('click', () => {
  regenerateAndReload().catch(err => console.error(err));
});
</script>

<table id="voyTable">
  <thead><tr><th>#</th><th>Start</th><th>End</th><th>NM</th><th>Max Speed</th><th>Avg Speed</th><th>Max Wind</th><th>Avg Wind</th><th>Avg Wind Dir</th></tr></thead>
  <tbody></tbody>
</table>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map, polylines = [];

async function load() {
  // fetch the data
  const res  = await fetch('voyages.json');
  const data = await res.json();

  // if map already exists (after regeneration), remove it
  if (map) {
    map.remove();
    polylines = [];
  }
  map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              { maxZoom: 19 }).addTo(map);

  const tbody = document.querySelector('#voyTable tbody');
  tbody.innerHTML = ''; // clear existing rows

  data.voyages.forEach((v, i) => {
    // create table row
    const avgWindDir = (v.avgWindHeading !== undefined && v.avgWindHeading !== null) ? degToCompass(v.avgWindHeading) : '';
    const row = tbody.insertRow();
    row.innerHTML =
      `<td>${i+1}</td><td>${new Date(v.startTime).toLocaleString()}</td>
       <td>${new Date(v.endTime).toLocaleString()}</td>
       <td>${v.nm.toFixed(1)}</td>
       <td>${v.maxSpeed.toFixed(1)}</td>
       <td>${v.avgSpeed.toFixed(1)}</td>
       <td>${v.maxWind.toFixed(1)}</td>
       <td>${v.avgWindSpeed.toFixed(1)}</td>
       <td>${avgWindDir}</td>`;

    // draw the polyline and store it
    const latLngs = v.coords.map(([lon, lat]) => [lat, lon]);
    const line = L.polyline(latLngs, { color: 'blue', weight: 2 }).addTo(map);
    polylines.push(line);
    if (i === 0) map.fitBounds(line.getBounds());

    // click handler to highlight this line
    row.addEventListener('click', () => {
      // reset all polylines to default style
      polylines.forEach(pl => pl.setStyle({ color: 'blue', weight: 2 }));
      // highlight selected voyage
      line.setStyle({ color: 'red', weight: 4 });
      // fit map bounds to selected line
      map.fitBounds(line.getBounds());
    });
  });
}

// call load() initially
load().catch(console.error);

// regenerate button logic, if you still have it
document.getElementById('regenBtn').addEventListener('click', async () => {
  await fetch('/plugins/voyage-webapp/generate', {
    method: 'GET',
    credentials: 'include'
  });
  await load();
});
</script>

</body>
</html>
